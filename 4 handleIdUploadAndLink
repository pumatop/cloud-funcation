import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';

/**
 * Ø¯Ø§Ù„Ø© Ø±Ø¨Ø· Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (TypeScript)
 * Ø§Ù„ÙˆØ¸ÙŠÙØ©: ØªØ­ÙˆÙŠÙ„ Ù…Ø³Ø§Ø± Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø¯Ø§Ø¦Ù… ÙˆØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
 */
export const handleIdUploadAndLink = functions.https.onCall(async (data, context) => {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    }

    const uid = context.auth.uid;
    const { storagePath }: { storagePath: string } = data; // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
    const db = admin.database();
    const bucket = admin.storage().bucket();

    if (!storagePath) {
        throw new functions.https.HttpsError('invalid-argument', 'Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© (storagePath) Ù…Ø·Ù„ÙˆØ¨');
    }

    try {
        // 2. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Download URL) Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨ØµÙ„Ø§Ø­ÙŠØ© Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ø£Ù…Ø¯
        const file = bucket.file(storagePath);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù ÙØ¹Ù„ÙŠØ§Ù‹ Ù‚Ø¨Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const [exists] = await file.exists();
        if (!exists) {
            throw new functions.https.HttpsError('not-found', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†');
        }

        const [url] = await file.getSignedUrl({
            action: 'read',
            expires: '01-01-2099' 
        });

        // 3. ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)
        const updates: { [key: string]: any } = {
            'profile/idCardUrl': url,
            'profile/verificationStatus': "PENDING",
            'metadata/idSubmittedAt': admin.database.ServerValue.TIMESTAMP
        };

        await db.ref(`users/${uid}`).update(updates);

        // 4. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
        
        // Ø£ - Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø¨Ø± Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡
        const userTokenSnap = await db.ref(`users/${uid}/fcmToken`).once('value');
        if (userTokenSnap.exists()) {
            const userPayload: admin.messaging.MessagingPayload = {
                notification: {
                    title: "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù‡ÙˆÙŠØªÙƒ ğŸ“„",
                    body: "Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒØŒ Ù‡ÙˆÙŠØªÙƒ Ø§Ù„Ø¢Ù† Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.",
                    clickAction: "FLUTTER_NOTIFICATION_CLICK"
                }
            };
            await admin.messaging().sendToDevice(userTokenSnap.val(), userPayload);
        }

        // Ø¨ - Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ø¹Ø¨Ø± Topic Ù…Ø®ØµØµ (admins_topic)
        const adminPayload: admin.messaging.MessagingPayload = {
            notification: {
                title: "Ø·Ù„Ø¨ ØªÙˆØ«ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯ ğŸ‘¤",
                body: "Ù‚Ø§Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø±ÙØ¹ ØµÙˆØ±Ø© Ù‡ÙˆÙŠØªÙ‡ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨."
            },
            data: {
                type: "NEW_VERIFICATION",
                userUid: uid,
                clickAction: "FLUTTER_NOTIFICATION_CLICK"
            }
        };
        
        await admin.messaging().sendToTopic("admins_topic", adminPayload);

        return { 
            success: true, 
            imageUrl: url,
            message: "ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­" 
        };

    } catch (error: any) {
        console.error("ID Upload Logic Error:", error);
        if (error instanceof functions.https.HttpsError) throw error;
        throw new functions.https.HttpsError('internal', `Ø­Ø¯Ø« Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ: ${error.message}`);
    }
});
