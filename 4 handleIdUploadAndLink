const functions = require('firebase-functions');
const admin = require('firebase-admin');

/**
 * Ø¯Ø§Ù„Ø© Ø±Ø¨Ø· Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø£Ø¯Ù…Ù†)
 */
exports.handleIdUploadAndLink = functions.https.onCall(async (data, context) => {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    }

    const uid = context.auth.uid;
    const { storagePath } = data; // Ø§Ù„Ù…Ø³Ø§Ø± ÙÙŠ Firebase Storage
    const db = admin.database();
    const bucket = admin.storage().bucket();

    if (!storagePath) {
        throw new functions.https.HttpsError('invalid-argument', 'Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© Ù…Ø·Ù„ÙˆØ¨');
    }

    try {
        // 2. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Download URL) Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        const file = bucket.file(storagePath);
        const [url] = await file.getSignedUrl({
            action: 'read',
            expires: '01-01-2099' 
        });

        // 3. ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const updates = {
            'profile/idCardUrl': url,
            'profile/verificationStatus': "PENDING",
            'metadata/idSubmittedAt': admin.database.ServerValue.TIMESTAMP
        };
        await db.ref(`users/${uid}`).update(updates);

        // 4. Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…)
        const userTokenSnap = await db.ref(`users/${uid}/fcmToken`).once('value');
        if (userTokenSnap.exists()) {
            const userPayload = {
                notification: {
                    title: "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù‡ÙˆÙŠØªÙƒ ğŸ“„",
                    body: "Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒØŒ Ù‡ÙˆÙŠØªÙƒ Ø§Ù„Ø¢Ù† Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©."
                }
            };
            await admin.messaging().sendToDevice(userTokenSnap.val(), userPayload);
        }

        // 5. Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø£Ø¯Ù…Ù† (ØªÙ†Ø¨ÙŠÙ‡ Ø¨ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯)
        const adminPayload = {
            notification: {
                title: "Ø·Ù„Ø¨ ØªÙˆØ«ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯ ğŸ‘¤",
                body: "Ù‚Ø§Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø±ÙØ¹ ØµÙˆØ±Ø© Ù‡ÙˆÙŠØªÙ‡ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨."
            },
            data: {
                click_action: "FLUTTER_NOTIFICATION_CLICK",
                type: "NEW_VERIFICATION",
                userUid: uid
            }
        };
        // Ù†Ø±Ø³Ù„ Ù„Ù„Ø£Ø¯Ù…Ù† Ø¹Ø¨Ø± "Topic" Ù…Ø®ØµØµ Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
        await admin.messaging().sendToTopic("admins_topic", adminPayload);

        return { 
            success: true, 
            imageUrl: url,
            message: "ØªÙ… Ø§Ù„Ø±ÙØ¹ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­" 
        };

    } catch (error) {
        console.error("Upload & Notify Error:", error);
        throw new functions.https.HttpsError('internal', "Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
    }
});
