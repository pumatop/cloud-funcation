const functions = require('firebase-functions');
const admin = require('firebase-admin');

if (admin.apps.length === 0) {
    admin.initializeApp();
}

exports.resetPasswordWithCode = functions.https.onCall(async (data, context) => {
    const { email, verificationCode, newPassword } = data;
    const db = admin.database();

    try {
        // 1. التحقق من الكود المخزن في Realtime Database
        const emailKey = email.replace(/\./g, '_'); // تحويل النقاط لتناسب مسارات Firebase
        const codeRef = db.ref(`temp_verification_codes/${emailKey}`);
        const snapshot = await codeRef.get();
        const storedData = snapshot.val();

        // التأكد من وجود الكود وصحته
        if (!storedData || storedData.code !== verificationCode) {
            throw new functions.https.HttpsError('invalid-argument', 'كود التحقق غير صحيح أو غير موجود');
        }

        // التأكد من صلاحية الكود (مثلاً 15 دقيقة)
        const isExpired = Date.now() - storedData.timestamp > 15 * 60 * 1000;
        if (isExpired) {
            await codeRef.remove();
            throw new functions.https.HttpsError('deadline-exceeded', 'انتهت صلاحية الكود');
        }

        // 2. الحصول على بيانات المستخدم من Auth
        const user = await admin.auth().getUserByEmail(email);
        const uid = user.uid;

        // 3. تغيير كلمة المرور في نظام الـ Auth
        await admin.auth().updateUser(uid, { password: newPassword });

        // 4. تحديث تاريخ التغيير في قاعدة البيانات (لتفعيل قاعدة الـ 24 ساعة للـ PIN)
        // وتسجيل خروج المستخدم برمجياً من كافة الأجهزة
        const updates = {};
        updates[`users/${uid}/security/password_last_changed`] = admin.database.ServerValue.TIMESTAMP;
        
        await db.ref().update(updates);
        await admin.auth().revokeRefreshTokens(uid);

        // 5. مسح كود التحقق بعد استخدامه بنجاح
        await codeRef.remove();

        // 6. إرسال إشعار Push Notification للمستخدم مباشرة
        const payload = {
            notification: {
                title: "تنبيه أمني",
                body: "تم تغيير كلمة المرور بنجاح وتم تسجيل الخروج من جميع الأجهزة."
            }
        };
        // نرسل الإشعار عبر الـ UID كموضوع (Topic)
        await admin.messaging().sendToTopic(uid, payload);

        return { success: true, message: "تمت العملية بنجاح" };

    } catch (error) {
        console.error("Error in resetPasswordWithCode:", error);
        throw new functions.https.HttpsError('internal', error.message);
    }
});
