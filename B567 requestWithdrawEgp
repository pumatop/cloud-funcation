const functions = require('firebase-functions');
const admin = require('firebase-admin');
const crypto = require('crypto');

/**
 * Ø¯Ø§Ù„Ø© Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØµØ±ÙŠ (ÙƒØ§Ø´ - Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ - ÙˆØµÙ„ÙŠ Ù„Ù„Ø¨ÙŠØª)
 * Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ù„Ø©: requestWithdrawEgp
 */
exports.requestWithdrawEgp = functions.https.onCall(async (data, context) => {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    if (!context.auth) throw new functions.https.HttpsError('unauthenticated', 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    
    const uid = context.auth.uid;
    const { 
        method,         // 'CASH', 'INSTAPAY', 'DELIVERY'
        amount, 
        pin, 
        recipientPhone, 
        recipientName,  // Ù…Ø·Ù„ÙˆØ¨ Ù„Ù€ "ÙˆØµÙ„ÙŠ Ù„Ù„Ø¨ÙŠØª"
        delegateUid     // Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙŠ Ø­Ø§Ù„Ø© "ÙˆØµÙ„ÙŠ Ù„Ù„Ø¨ÙŠØª"
    } = data;
    
    const db = admin.database();

    try {
        // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…)
        const [userSnap, settingsSnap] = await Promise.all([
            db.ref(`users/${uid}`).once('value'),
            db.ref('settings/withdraw_configs').once('value')
        ]);

        const userData = userSnap.val();
        const configs = settingsSnap.val(); // ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³ÙˆÙ… ÙˆØ§Ù„Ø­Ø¯ÙˆØ¯ Ù„ÙƒÙ„ Ø·Ø±ÙŠÙ‚Ø©

        // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø£Ù…Ø§Ù†
        if (userData.profile.isFrozen) throw new functions.https.HttpsError('permission-denied', 'Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…Ø¯');
        
        const hashedPin = crypto.createHash('sha256').update(pin).digest('hex');
        if (hashedPin !== userData.profile.pin) throw new functions.https.HttpsError('permission-denied', 'Ø±Ù…Ø² PIN ØºÙŠØ± ØµØ­ÙŠØ­');

        // 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯ ÙˆØ§Ù„Ø±Ø³ÙˆÙ… Ù„ÙƒÙ„ Ø®Ø¯Ù…Ø©
        const serviceConfig = configs[method];
        if (!serviceConfig) throw new functions.https.HttpsError('invalid-argument', 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø­Ø¨ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©');

        if (amount < serviceConfig.minAmount || amount > serviceConfig.maxAmount) {
            throw new functions.https.HttpsError('out-of-range', `Ø§Ù„Ù…Ø¨Ù„Øº Ø®Ø§Ø±Ø¬ Ø§Ù„Ø­Ø¯ÙˆØ¯ (Ù…Ø³Ù…ÙˆØ­ Ù…Ù† ${serviceConfig.minAmount} Ø¥Ù„Ù‰ ${serviceConfig.maxAmount})`);
        }

        const fee = serviceConfig.fee;
        const totalAmountToSuspend = amount + fee;

        if (userData.wallets.egp_balance < totalAmountToSuspend) {
            throw new functions.https.HttpsError('insufficient-funds', 'Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ù…ØµØ±ÙŠ Ù„Ø§ ÙŠÙƒÙÙŠ Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„Ø±Ø³ÙˆÙ…');
        }

        // 5. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù…Ø§Ù„ÙŠ
        const requestKey = db.ref('withdraw_requests').push().key;
        const now = new Date();
        const dayKey = now.toISOString().split('T')[0];
        const monthKey = dayKey.substring(0, 7);

        const requestEntry = {
            requestId: requestKey,
            senderUid: uid,
            senderPhone: userData.profile.phoneNumber,
            method: method,
            amount: amount,
            fee: fee,
            recipientPhone: recipientPhone,
            recipientName: method === 'DELIVERY' ? recipientName : "Digital Transfer",
            assignedDelegate: (method === 'DELIVERY') ? delegateUid : "OPEN_MARKET",
            status: "PENDING_MANUAL_TRANSFER",
            requiresReceipt: (method !== 'DELIVERY'), // Ø§Ù„Ù…Ø­Ø§ÙØ¸ ÙˆØ§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ ØªØªØ·Ù„Ø¨ Ø¥ÙŠØµØ§Ù„
            timestamp: admin.database.ServerValue.TIMESTAMP
        };

        const updates = {};
        
        // ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø±ØµÙŠØ¯: Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…ØªØ§Ø­ ÙˆØ¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø¹Ù„Ù‚
        updates[`users/${uid}/wallets/egp_balance`] = admin.database.ServerValue.increment(-totalAmountToSuspend);
        updates[`users/${uid}/wallets/egp_pending_balance`] = admin.database.ServerValue.increment(totalAmountToSuspend);
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
        updates[`withdraw_requests/${requestKey}`] = requestEntry;
        updates[`users/${uid}/history/withdrawals/${requestKey}`] = requestEntry;
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³ÙˆÙ… Ù„Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ© (Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø§Ø­Ù‚Ø§Ù‹ØŒ Ø£Ùˆ ØªØ³Ø¬Ù„ Ø§Ù„Ø¢Ù† ÙƒØ¥ÙŠØ±Ø§Ø¯ Ù…ØªÙˆÙ‚Ø¹)
        updates[`stats/revenue/egp_fees/daily/${dayKey}`] = admin.database.ServerValue.increment(fee);
        updates[`stats/revenue/egp_fees/monthly/${monthKey}`] = admin.database.ServerValue.increment(fee);

        // Ù†Ø³Ø®Ø© Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø§Ù…Ù„
        updates[`stats/logs/all_withdrawals/${requestKey}`] = requestEntry;

        await db.ref().update(updates);

        // 6. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ
        const notificationPayload = {
            notification: {
                title: "Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯ ğŸ’¸",
                body: `Ø·Ø±ÙŠÙ‚Ø©: ${method} - Ù…Ø¨Ù„Øº: ${amount} Ø¬.Ù…`
            },
            data: { requestId: requestKey, method: method }
        };

        // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ØµØ­Ø© Ø§Ù„Ø·Ù„Ø¨ ÙˆØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ù„Øº
        if (userData.fcmToken) {
            await admin.messaging().sendToDevice(userData.fcmToken, {
                notification: { title: "ØªÙ… ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ù†Ø¬Ø§Ø­ â³", body: "Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ ÙˆØªØ­ÙˆÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¹Ø¨Ø± Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨." }
            });
        }

        // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨
        if (method === 'DELIVERY' && delegateUid) {
            // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù…Ø¹ÙŠÙ† (ÙˆØµÙ„ÙŠ Ù„Ù„Ø¨ÙŠØª)
            const delegateSnap = await db.ref(`users/${delegateUid}/fcmToken`).once('value');
            if (delegateSnap.exists()) {
                await admin.messaging().sendToDevice(delegateSnap.val(), notificationPayload);
            }
        } else {
            // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ù…Ø© (ÙƒØ§Ø´ ÙˆØ§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ) Ø¹Ø¨Ø± Topic Ù…Ø®ØµØµ Ù„Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨
            await admin.messaging().sendToTopic("general_delegates_egp", notificationPayload);
        }

        return { success: true, message: "ØªÙ… ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨", requestId: requestKey };

    } catch (e) {
        throw new functions.https.HttpsError('internal', e.message);
    }
});


//Ø´Ø±Ø­ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ:
Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ (Pending): Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ®ØµÙ… (Ø§Ù„Ù…Ø¨Ù„Øº + Ø§Ù„Ø±Ø³ÙˆÙ…) ÙÙˆØ±Ø§Ù‹ Ù…Ù† egp_balance ÙˆØªØ¶Ø¹Ù‡Ø§ ÙÙŠ egp_pending_balance. Ù‡Ø°Ø§ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù…Ø­Ø§ÙˆÙ„Ø© Ø³Ø­Ø¨ Ù†ÙØ³ Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ø±ØªÙŠÙ† Ù‚Ø¨Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨.

Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø°ÙƒÙŠ (Routing):

ÙÙŠ ÙˆØµÙ„ÙŠ Ù„Ù„Ø¨ÙŠØª: ÙŠÙØ±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù…Ø­Ø¯Ø¯ (delegateUid) Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù… Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù…).

ÙÙŠ ÙƒØ§Ø´/Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ: ÙŠÙÙ†Ø´Ø± Ø§Ù„Ø·Ù„Ø¨ ÙƒÙ€ "Ø·Ù„Ø¨ Ø¹Ø§Ù…" Ù„ÙŠØ±Ø§Ù‡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ Ø¹Ø¨Ø± Topic Ù…Ø®ØµØµ.

Ø´Ø±Ø· Ø§Ù„Ø¥ÙŠØµØ§Ù„ (Receipt Requirement): ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ requiresReceipt. ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø¯Ù…Ù†ØŒ Ù„Ù† ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù…Ù† Ø¶ØºØ· "ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„" Ù„Ù„Ù…Ø­Ø§ÙØ¸ ÙˆØ§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ØŒ Ø¨ÙŠÙ†Ù…Ø§ ÙÙŠ "ÙˆØµÙ„ÙŠ Ù„Ù„Ø¨ÙŠØª" ÙŠÙÙƒØªÙÙ‰ Ø¨ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙŠØ¯ÙˆÙŠ.

Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©: ØªÙ‚ÙˆÙ… Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨ØªØ­Ø¯ÙŠØ« stats/revenue/egp_fees Ø¨Ø´ÙƒÙ„ ÙŠÙˆÙ…ÙŠ ÙˆØ´Ù‡Ø±ÙŠ Ø¢Ù„ÙŠØ§Ù‹ Ø¨Ù…Ø¬Ø±Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŒ Ù…Ù…Ø§ ÙŠØ³Ù‡Ù„ Ø¹Ù„ÙŠÙƒ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ù…Ù† Ø§Ù„Ø±Ø³ÙˆÙ… ÙÙˆØ±ÙŠØ§Ù‹.

Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ù…Ù†ÙØ°: ØªÙ… Ø­Ø¬Ø² Ù…ÙƒØ§Ù† ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (assignedDelegate) Ù„ØªÙˆØ«ÙŠÙ‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ø°ÙŠ Ø§Ø³ØªÙ„Ù… Ø£Ùˆ Ø³ÙŠØ³ØªÙ„Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.
