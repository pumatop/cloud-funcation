const functions = require('firebase-functions');
const admin = require('firebase-admin');
const crypto = require('crypto');

/**
 * Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
 */
function hashData(data) {
    return crypto.createHash('sha256').update(data).digest('hex');
}

/**
 * Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù…ØªØ§Ø­Ø© ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª ÙˆØ¨Ø¯ÙˆÙ† Ù‚ÙŠÙˆØ¯ Ø²Ù…Ù†ÙŠØ©)
 * Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ù„Ø©: updateUserPassword
 */
exports.updateUserPassword = functions.https.onCall(async (data, context) => {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    }

    const uid = context.auth.uid;
    const { oldPassword, newPassword, resetCode, method } = data; // method: 'OLD_PASS' Ø£Ùˆ 'RESET_CODE'
    const db = admin.database();

    try {
        const userRef = db.ref(`users/${uid}/profile`);
        const snapshot = await userRef.once('value');
        const userData = snapshot.val();

        // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        if (method === 'OLD_PASS') {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            if (hashData(oldPassword) !== userData.password) {
                throw new functions.https.HttpsError('permission-denied', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            }
        } else if (method === 'RESET_CODE') {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© (ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ù†Ø³ÙŠØ§Ù†)
            const tempCodeSnap = await db.ref(`temp_codes/${uid}/password_reset`).once('value');
            if (!tempCodeSnap.exists() || tempCodeSnap.val() !== resetCode) {
                throw new functions.https.HttpsError('permission-denied', 'ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
            }
            // Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
            await db.ref(`temp_codes/${uid}/password_reset`).remove();
        } else {
            throw new functions.https.HttpsError('invalid-argument', 'ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØºÙŠÙŠØ± (ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚Ø¯ÙŠÙ…Ø© Ø£Ù… ÙƒÙˆØ¯ ØªØ­Ù‚Ù‚)');
        }

        // 3. ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ­ÙØ¸ ÙˆÙ‚Øª Ø§Ù„ØªØºÙŠÙŠØ±
        const hashedPassword = hashData(newPassword);
        await userRef.update({
            password: hashedPassword,
            lastPasswordChange: admin.database.ServerValue.TIMESTAMP
        });

        // 4. Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù‚ØµÙˆÙ‰: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† ÙƒØ§ÙØ© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
        await admin.auth().revokeRefreshTokens(uid);

        // 5. Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const fcmTokenSnap = await db.ref(`users/${uid}/fcmToken`).once('value');
        if (fcmTokenSnap.exists()) {
            const payload = {
                notification: {
                    title: "ØªØ­Ø¯ÙŠØ« Ø£Ù…Ù†ÙŠ ğŸ›¡ï¸",
                    body: "ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø®Ø±Ù‰ Ù„Ø¶Ù…Ø§Ù† Ø£Ù…Ø§Ù†Ùƒ."
                }
            };
            await admin.messaging().sendToDevice(fcmTokenSnap.val(), payload);
        }

        return { 
            success: true, 
            message: "ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø®Ø±Ù‰" 
        };

    } catch (error) {
        throw new functions.https.HttpsError('internal', error.message);
    }
});
