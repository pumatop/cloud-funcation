import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';
import * as crypto from 'crypto';

/**
 * ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SHA-256
 */
const hashData = (data: string): string => {
    return crypto.createHash('sha256').update(data).digest('hex');
};

/**
 * Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (TypeScript)
 * ØªØªÙŠØ­ Ø§Ù„ØªØºÙŠÙŠØ± Ø¹Ø¨Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
 */
export const updateUserPassword = functions.https.onCall(async (data, context) => {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    }

    const uid = context.auth.uid;
    const { oldPassword, newPassword, resetCode, method } = data; 
    // method Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: 'OLD_PASS' | 'RESET_CODE'
    
    const db = admin.database();

    try {
        const userRef = db.ref(`users/${uid}/profile`);
        const snapshot = await userRef.once('value');
        
        if (!snapshot.exists()) {
            throw new functions.https.HttpsError('not-found', 'Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        }
        
        const userData = snapshot.val();

        // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©
        if (method === 'OLD_PASS') {
            if (!oldPassword) throw new functions.https.HttpsError('invalid-argument', 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©');
            
            if (hashData(oldPassword) !== userData.password) {
                throw new functions.https.HttpsError('permission-denied', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            }
        } 
        else if (method === 'RESET_CODE') {
            if (!resetCode) throw new functions.https.HttpsError('invalid-argument', 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©');
            
            const tempCodeSnap = await db.ref(`temp_codes/${uid}/password_reset`).once('value');
            if (!tempCodeSnap.exists() || tempCodeSnap.val() !== resetCode) {
                throw new functions.https.HttpsError('permission-denied', 'ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
            }
            // Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
            await db.ref(`temp_codes/${uid}/password_reset`).remove();
        } 
        else {
            throw new functions.https.HttpsError('invalid-argument', 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØºÙŠÙŠØ± ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©');
        }

        // 3. Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¹Ù„ÙŠ ÙˆØ­ÙØ¸ Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ
        const hashedPassword = hashData(newPassword);
        await userRef.update({
            password: hashedPassword,
            lastPasswordChange: admin.database.ServerValue.TIMESTAMP
        });

        // 4. ØªØ·Ù‡ÙŠØ± Ø§Ù„Ø¬Ù„Ø³Ø§Øª (Revoke Tokens)
        // Ø·Ø±Ø¯ Ø£ÙŠ Ù…Ø®ØªØ±Ù‚ Ø£Ùˆ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹
        await admin.auth().revokeRefreshTokens(uid);

        // 5. Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ù…Ø§Ù† Ø¹Ø¨Ø± FCM
        const fcmTokenSnap = await db.ref(`users/${uid}/fcmToken`).once('value');
        if (fcmTokenSnap.exists()) {
            const payload: admin.messaging.MessagingPayload = {
                notification: {
                    title: "ØªØ­Ø¯ÙŠØ« Ø£Ù…Ù†ÙŠ ğŸ›¡ï¸",
                    body: "ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­. ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø®Ø±Ù‰ Ù„Ø¶Ù…Ø§Ù† Ø£Ù…Ø§Ù†Ùƒ.",
                    sound: "default"
                }
            };
            await admin.messaging().sendToDevice(fcmTokenSnap.val(), payload);
        }

        return { 
            success: true, 
            message: "ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ·Ø±Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©" 
        };

    } catch (error: any) {
        if (error instanceof functions.https.HttpsError) throw error;
        throw new functions.https.HttpsError('internal', error.message);
    }
});
