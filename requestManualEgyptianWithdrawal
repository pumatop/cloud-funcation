const functions = require('firebase-functions');
const admin = require('firebase-admin');

if (admin.apps.length === 0) {
    admin.initializeApp();
}

/**
 * دالة طلب السحب اليدوي المصري مع الرسوم والحدود:
 * 1. التأكد من حدود العملية (مثلاً بين 100 و 50,000 جنيه).
 * 2. حساب رسوم الخدمة وخصمها مع المبلغ من رصيد المستخدم.
 * 3. إضافة الرسوم إلى "إيرادات رسوم العمليات المصرية".
 * 4. إنشاء طلب للمشرف ليقوم بالتحويل اليدوي ورفع الإيصال.
 */
exports.requestManualEgyptianWithdrawal = functions.https.onCall(async (data, context) => {
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'يجب تسجيل الدخول أولاً');
    }

    const uid = context.auth.uid;
    const { phoneNumber, walletType, amount } = data;
    const withdrawAmount = parseFloat(amount);
    const db = admin.database();

    // --- 1. إعدادات الحدود والرسوم ---
    const MIN_LIMIT = 100;      // أدنى مبلغ للسحب بالجنيه
    const MAX_LIMIT = 50000;    // أقصى مبلغ للسحب بالجنيه
    const SERVICE_FEE = 5.0;    // رسوم ثابتة (مثلاً 5 جنيه) أو يمكنك جعلها نسبة
    const totalDeduction = withdrawAmount + SERVICE_FEE;

    // --- 2. التأكد من حدود العملية ---
    if (withdrawAmount < MIN_LIMIT || withdrawAmount > MAX_LIMIT) {
        throw new functions.https.HttpsError('out-of-range', `المبلغ يجب أن يكون بين ${MIN_LIMIT} و ${MAX_LIMIT} جنيه مصري`);
    }

    try {
        // --- 3. الخصم من رصيد المستخدم (EGP) ---
        const walletRef = db.ref(`users/${uid}/wallets/egp_balance`);
        const transactionResult = await walletRef.transaction((currentBalance) => {
            if (currentBalance === null) return 0;
            if (currentBalance < totalDeduction) return; // رصيد غير كافٍ لتغطية المبلغ + الرسوم
            return currentBalance - totalDeduction;
        });

        if (!transactionResult.committed) {
            throw new functions.https.HttpsError('failed-precondition', 'رصيدك لا يكفي لتغطية المبلغ ورسوم الخدمة');
        }

        // --- 4. إضافة الرسوم إلى إيرادات المنصة (قسم العمليات المصرية) ---
        await db.ref('metadata/platform_revenue_egp_fees').transaction((currentRevenue) => {
            return (currentRevenue || 0) + SERVICE_FEE;
        });

        // --- 5. إنشاء طلب سحب يظهر في لوحة تحكم المشرف (Admin) ---
        const requestRef = db.ref('admin_pending_withdrawals').push();
        const requestId = requestRef.key;

        await requestRef.set({
            uid: uid,
            amount: withdrawAmount,
            fee: SERVICE_FEE,
            phoneNumber: phoneNumber,
            walletType: walletType,
            status: 'PENDING',
            receipt_url: '', // سيقوم المشرف برفعه لاحقاً
            timestamp: admin.database.ServerValue.TIMESTAMP
        });

        // --- 6. تسجيل العملية في سجل المستخدم ---
        await db.ref(`users/${uid}/withdrawals/${requestId}`).set({
            amount: withdrawAmount,
            fee: SERVICE_FEE,
            status: 'PROCESSING',
            timestamp: admin.database.ServerValue.TIMESTAMP
        });

        return { 
            success: true, 
            message: "تم إرسال طلب السحب للمشرف، سيتم إشعارك فور رفع إيصال التحويل" 
        };

    } catch (error) {
        console.error("Manual Egyptian Withdrawal Error:", error);
        throw new functions.https.HttpsError('internal', error.message);
    }
});
