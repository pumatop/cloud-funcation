const functions = require('firebase-functions');
const admin = require('firebase-admin');
const crypto = require('crypto');
const axios = require('axios');

/**
 * Ø¯Ø§Ù„Ø© Ø´Ø±Ø§Ø¡ ÙƒØ±ÙˆØª Ø§Ù„Ø´Ø­Ù† (Ø§Ù„Ù…Ø¯Ø§Ø±ØŒ Ù„ÙŠØ¨ÙŠØ§Ù†Ø§ØŒ LTT)
 * Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ØªÙØ­Ø³Ø¨ ÙƒØ¥ÙŠØ±Ø§Ø¯ Ù„Ù„Ù…Ù†ØµØ©
 */
exports.purchaseTelecomCard = functions.https.onCall(async (data, context) => {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    if (!context.auth) throw new functions.https.HttpsError('unauthenticated', 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    
    const uid = context.auth.uid;
    const { provider, cardValue, pin } = data; // Ø§Ù„Ù…Ø¯Ø§Ø±ØŒ Ù„ÙŠØ¨ÙŠØ§Ù†Ø§ØŒ Ø£Ùˆ LTT ÙˆØ§Ù„Ù‚ÙŠÙ…Ø© (Ù…Ø«Ù„Ø§Ù‹ 5ØŒ 10 Ø¯.Ù„)
    const db = admin.database();

    try {
        // 2. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù€ API
        const [userSnap, apiSettingsSnap] = await Promise.all([
            db.ref(`users/${uid}`).once('value'),
            db.ref('settings/telecom_api').once('value')
        ]);

        const userData = userSnap.val();
        const apiSettings = apiSettingsSnap.val();

        // 3. Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ù…Ù†ÙŠØ©
        if (userData.profile.isFrozen) throw new functions.https.HttpsError('permission-denied', 'Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¬Ù…Ø¯');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† PIN
        const hashedPin = crypto.createHash('sha256').update(pin).digest('hex');
        if (hashedPin !== userData.profile.pin) {
            throw new functions.https.HttpsError('permission-denied', 'Ø±Ù…Ø² PIN ØºÙŠØ± ØµØ­ÙŠØ­');
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
        const totalCost = parseFloat(cardValue);
        if (userData.wallets.lyd_balance < totalCost) {
            throw new functions.https.HttpsError('insufficient-funds', 'Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ Ù„Ø´Ø±Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ±Øª');
        }

        // 4. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ API Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
        // ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù„Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
        const apiResponse = await axios.post(apiSettings.url, {
            apiKey: apiSettings.key,
            service: provider,
            amount: cardValue
        }).catch(err => {
            throw new functions.https.HttpsError('internal', 'Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ');
        });

        if (apiResponse.data.status !== 'success') {
            throw new functions.https.HttpsError('unavailable', 'Ø§Ù„Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹');
        }

        const voucherCode = apiResponse.data.pin_code; // ÙƒÙˆØ¯ Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø³ØªÙ„Ù…

        // 5. Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ© (Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©)
        const now = new Date();
        const dayKey = now.toISOString().split('T')[0];
        const monthKey = dayKey.substring(0, 7);
        const updates = {};

        // Ø®ØµÙ… Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        updates[`users/${uid}/wallets/lyd_balance`] = admin.database.ServerValue.increment(-totalCost);

        // ØªØ³Ø¬ÙŠÙ„ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ (Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø­Ø³Ø¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ)
        updates[`stats/revenue/telecom_cards/daily/${dayKey}`] = admin.database.ServerValue.increment(totalCost);
        updates[`stats/revenue/telecom_cards/monthly/${monthKey}`] = admin.database.ServerValue.increment(totalCost);
        updates[`stats/revenue/telecom_cards/total_all_time`] = admin.database.ServerValue.increment(totalCost);

        // Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const logKey = db.ref(`users/${uid}/history/telecom_purchases`).push().key;
        const logData = {
            provider,
            cardValue: totalCost,
            voucherCode,
            timestamp: admin.database.ServerValue.TIMESTAMP,
            status: "SUCCESS"
        };
        updates[`users/${uid}/history/telecom_purchases/${logKey}`] = logData;

        // Ù†Ø³Ø®Ø© Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…Ù†ØµØ© (Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ)
        updates[`stats/logs/telecom_sales/${logKey}`] = { ...logData, userUid: uid };

        await db.ref().update(updates);

        // 6. Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (userData.fcmToken) {
            await admin.messaging().sendToDevice(userData.fcmToken, {
                notification: {
                    title: "Ø´Ø±Ø§Ø¡ Ù†Ø§Ø¬Ø­ ğŸ‰",
                    body: `ÙƒÙˆØ¯ Ø´Ø­Ù† ${provider}: ${voucherCode}. ØªÙ… Ø®ØµÙ… ${totalCost} Ø¯.Ù„ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ.`
                }
            });
        }

        return { success: true, voucher: voucherCode };

    } catch (e) {
        throw new functions.https.HttpsError('internal', e.message);
    }
});

Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª: ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ù„Ø±Ø³ÙˆÙ… Ø£Ùˆ "Ø§Ù„ÙÙŠØ²" (Fees).

Ø¥ÙŠØ±Ø§Ø¯ Ù…Ø¨Ø§Ø´Ø±: Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø®ØµÙˆÙ… Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (totalCost) ÙŠÙØ¶Ø§Ù Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ÙˆØ§Ù„Ø´Ù‡Ø±ÙŠØ© Ù„Ù„Ù…Ù†ØµØ© ØªØ­Øª Ø¨Ù†Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙƒØ±ÙˆØª.

Ø§Ù„ØªØ±Ø§ÙƒÙ… Ø§Ù„Ø°ÙƒÙŠ: ØªÙØ³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø´ÙƒÙ„ ØªØ±Ø§ÙƒÙ…ÙŠ ÙŠÙˆÙ…ÙŠ (daily) ÙˆØ´Ù‡Ø±ÙŠ (monthly) ÙˆØ¥Ø¬Ù…Ø§Ù„ÙŠ (total_all_time) Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø®ØªØ§Ù…ÙŠØ©.

Ø§Ù„ØªÙˆØ«ÙŠÙ‚: ÙŠØªÙ… Ø­ÙØ¸ ÙƒÙˆØ¯ Ø§Ù„ÙƒØ±Øª Ø§Ù„Ù…Ø³ØªÙ„Ù… Ù…Ù† Ø§Ù„Ù€ API ÙÙŠ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¶Ù…Ø§Ù† ÙˆØµÙˆÙ„Ù‡ Ø¥Ù„ÙŠÙ‡ Ø­ØªÙ‰ Ù„Ùˆ ÙÙ‚Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±.
