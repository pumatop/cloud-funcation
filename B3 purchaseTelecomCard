import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';
import * as crypto from 'crypto';
import axios from 'axios';

// --- ØªØ¹Ø±ÙŠÙ ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---

interface TelecomApiSettings {
    url: string;
    key: string;
}

interface ApiResponse {
    status: string;
    pin_code: string;
    message?: string;
}

/**
 * Ø¯Ø§Ù„Ø© Ø´Ø±Ø§Ø¡ ÙƒØ±ÙˆØª Ø§Ù„Ø´Ø­Ù† (Ø§Ù„Ù…Ø¯Ø§Ø±ØŒ Ù„ÙŠØ¨ÙŠØ§Ù†Ø§ØŒ LTT)
 * Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ØªÙØ­Ø³Ø¨ ÙƒØ¥ÙŠØ±Ø§Ø¯ Ù„Ù„Ù…Ù†ØµØ© Ø¨Ø´ÙƒÙ„ ØªØ±Ø§ÙƒÙ…ÙŠ
 */
export const purchaseTelecomCard = functions.https.onCall(async (data, context) => {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    }

    const uid = context.auth.uid;
    const { provider, cardValue, pin }: { provider: string, cardValue: number | string, pin: string } = data;
    const db = admin.database();

    try {
        // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙˆØ§Ø²ÙŠØ© (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø²ÙˆØ¯)
        const [userSnap, apiSettingsSnap] = await Promise.all([
            db.ref(`users/${uid}`).once('value'),
            db.ref('settings/telecom_api').once('value')
        ]);

        if (!userSnap.exists()) throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
        const userData = userSnap.val();
        const apiSettings = apiSettingsSnap.val() as TelecomApiSettings;

        // 3. Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©
        if (userData.profile.isFrozen) {
            throw new functions.https.HttpsError('permission-denied', 'Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¬Ù…Ø¯ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø­Ø§Ù„ÙŠØ§Ù‹');
        }

        const hashedPin = crypto.createHash('sha256').update(pin).digest('hex');
        if (hashedPin !== userData.profile.pin) {
            throw new functions.https.HttpsError('permission-denied', 'Ø±Ù…Ø² PIN ØºÙŠØ± ØµØ­ÙŠØ­');
        }

        const totalCost = typeof cardValue === 'string' ? parseFloat(cardValue) : cardValue;
        if (userData.wallets.lyd_balance < totalCost) {
            throw new functions.https.HttpsError('insufficient-funds', 'Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ Ù„Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡');
        }

        // 4. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ (External API)
        const response = await axios.post<ApiResponse>(apiSettings.url, {
            apiKey: apiSettings.key,
            service: provider,
            amount: cardValue
        }).catch(err => {
            console.error("Axios Error:", err.message);
            throw new functions.https.HttpsError('internal', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ø²ÙˆØ¯ Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ');
        });

        if (response.data.status !== 'success') {
            throw new functions.https.HttpsError('unavailable', `Ø§Ù„Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ø§Ø¹ØªØ°Ø± Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨: ${response.data.message || 'ØºÙŠØ± Ù…ØªØ§Ø­'}`);
        }

        const voucherCode = response.data.pin_code;

        // 5. Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ© (Atomic Updates)
        const now = new Date();
        const dayKey = now.toISOString().split('T')[0];
        const monthKey = dayKey.substring(0, 7);
        const updates: { [key: string]: any } = {};

        // Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯
        updates[`users/${uid}/wallets/lyd_balance`] = admin.database.ServerValue.increment(-totalCost);

        // Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ© Ù„Ù„Ù…Ù†ØµØ©
        updates[`stats/revenue/telecom_cards/daily/${dayKey}`] = admin.database.ServerValue.increment(totalCost);
        updates[`stats/revenue/telecom_cards/monthly/${monthKey}`] = admin.database.ServerValue.increment(totalCost);
        updates[`stats/revenue/telecom_cards/total_all_time`] = admin.database.ServerValue.increment(totalCost);

        // Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        const logKey = db.ref(`users/${uid}/history/telecom_purchases`).push().key;
        const logData = {
            provider,
            cardValue: totalCost,
            voucherCode,
            timestamp: admin.database.ServerValue.TIMESTAMP,
            status: "SUCCESS"
        };

        updates[`users/${uid}/history/telecom_purchases/${logKey}`] = logData;
        updates[`stats/logs/telecom_sales/${logKey}`] = { ...logData, userUid: uid };

        await db.ref().update(updates);

        // 6. Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù„Ø­Ø¸ÙŠØ©
        if (userData.fcmToken) {
            await admin.messaging().sendToDevice(userData.fcmToken, {
                notification: {
                    title: "Ø´Ø±Ø§Ø¡ Ù†Ø§Ø¬Ø­ ğŸ‰",
                    body: `ÙƒÙˆØ¯ Ø´Ø­Ù† ${provider}: ${voucherCode}. ØªÙ… Ø®ØµÙ… ${totalCost} Ø¯.Ù„.`
                }
            });
        }

        return { success: true, voucher: voucherCode };

    } catch (error: any) {
        console.error("Telecom Purchase Error:", error);
        if (error instanceof functions.https.HttpsError) throw error;
        throw new functions.https.HttpsError('internal', error.message);
    }
});
