const functions = require('firebase-functions');
const admin = require('firebase-admin');

// تهيئة التطبيق
if (admin.apps.length === 0) {
    admin.initializeApp();
}

/**
 * دالة إنشاء الحساب:
 * 1. تعمل تلقائياً عند تسجيل مستخدم جديد في Firebase Auth.
 * 2. تضع الرصيد الليبي والمصري (0).
 * 3. تمنع المستخدم من الكتابة (تتم عبر الدالة فقط لضمان الأمان).
 * 4. تحدث عداد المستخدمين الإجمالي للمنصة (تراكمي).
 */
exports.onUserCreation = functions.auth.user().onCreate(async (user) => {
    const uid = user.uid;
    const userEmail = user.email;
    const db = admin.database();

    // هيكل البيانات الأساسي للمستخدم
    const initialData = {
        info: {
            email: userEmail,
            created_at: admin.database.ServerValue.TIMESTAMP,
            role: "user" // رتبة المستخدم
        },
        wallets: {
            lyd_balance: 0, // الرصيد الليبي (صفر عند البداية)
            egp_balance: 0, // الرصيد المصري (صفر عند البداية)
        },
        security: {
            pin: "1234", // PIN افتراضي
            password_last_changed: admin.database.ServerValue.TIMESTAMP // مرجع لقاعدة الـ 24 ساعة
        }
    };

    try {
        // الدالة هي الوحيدة التي تملك صلاحية كتابة البيانات الأولية
        await db.ref(`users/${uid}`).set(initialData);

        // تحديث إحصائيات المنصة (زيادة عدد المستخدمين +1)
        await db.ref('metadata/total_users').transaction((currentValue) => {
            return (currentValue || 0) + 1;
        });

        console.log(`تم إنشاء حساب المستخدم بنجاح: ${uid}`);
        return null;
    } catch (error) {
        console.error("خطأ في إنشاء سجل المستخدم:", error);
        return null;
    }
});
