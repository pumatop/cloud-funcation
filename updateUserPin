const functions = require('firebase-functions');
const admin = require('firebase-admin');

if (admin.apps.length === 0) {
    admin.initializeApp();
}

/**
 * دالة تغيير رمز الـ PIN:
 * 1. تتحقق من هوية المستخدم.
 * 2. تتحقق من مرور 24 ساعة على آخر تغيير لكلمة المرور.
 * 3. تتطلب كود تحقق (Verification Code) لتنفيذ العملية.
 */
exports.updateUserPin = functions.https.onCall(async (data, context) => {
    // 1. التأكد من تسجيل الدخول
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'يجب تسجيل الدخول أولاً');
    }

    const uid = context.auth.uid;
    const { newPin, verificationCode } = data;
    const db = admin.database();

    try {
        // 2. جلب بيانات الأمان الخاصة بالمستخدم
        const userSecurityRef = db.ref(`users/${uid}/security`);
        const snapshot = await userSecurityRef.get();
        const securityData = snapshot.val();

        if (!securityData) {
            throw new functions.https.HttpsError('not-found', 'بيانات المستخدم غير موجودة');
        }

        // 3. تطبيق قاعدة الـ 24 ساعة
        const lastPasswordChange = securityData.password_last_changed; // الطابع الزمني بالملي ثانية
        const currentTime = Date.now();
        const twentyFourHoursInMs = 24 * 60 * 60 * 1000;

        if (currentTime - lastPasswordChange < twentyFourHoursInMs) {
            const remainingTime = Math.ceil((twentyFourHoursInMs - (currentTime - lastPasswordChange)) / (1000 * 60 * 60));
            throw new functions.https.HttpsError(
                'failed-precondition', 
                `لا يمكنك تغيير الـ PIN إلا بعد مرور 24 ساعة من تغيير كلمة المرور. تبقى ${remainingTime} ساعة تقريباً.`
            );
        }

        // 4. التحقق من كود التحقق (يُفترض أنك خزنته مسبقاً في مسار مؤقت)
        const emailKey = securityData.email ? securityData.email.replace(/\./g, '_') : uid; 
        const codeSnapshot = await db.ref(`temp_verification_codes/${uid}`).get();
        const storedCode = codeSnapshot.val();

        if (!storedCode || storedCode.code !== verificationCode) {
            throw new functions.https.HttpsError('invalid-argument', 'كود التحقق غير صحيح أو انتهت صلاحيته');
        }

        // 5. تنفيذ تغيير الـ PIN وتحديث تاريخ التغيير
        await userSecurityRef.update({
            pin: newPin,
            pin_last_changed: admin.database.ServerValue.TIMESTAMP
        });

        // 6. مسح كود التحقق بعد النجاح
        await db.ref(`temp_verification_codes/${uid}`).remove();

        // 7. إرسال إشعار للمستخدم
        const payload = {
            notification: {
                title: "تحديث أمني",
                body: "تم تغيير رمز الـ PIN الخاص بك بنجاح."
            }
        };
        await admin.messaging().sendToTopic(uid, payload);

        return { success: true, message: "تم تحديث رمز الـ PIN بنجاح" };

    } catch (error) {
        console.error("Error updating PIN:", error);
        // إعادة إرسال الخطأ لـ Dart بشكل مفهوم
        throw new functions.https.HttpsError(error.code || 'internal', error.message);
    }
});
