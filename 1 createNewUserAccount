import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';
import * as crypto from 'crypto';

admin.initializeApp();
const db = admin.database();

// --- 1. ØªØ¹Ø±ÙŠÙ ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Interfaces) ---

interface UserWallets {
    lyd_balance: number;
    egp_balance: number;
    egp_pending_balance: number;
}

interface UserProfile {
    fullName: string;
    phoneNumber: string;
    password: string;
    pin: string;
    userType: 'USER' | 'MERCHANT' | 'ADMIN' | 'DELEGATE';
    verificationStatus: 'UNVERIFIED' | 'PENDING' | 'VERIFIED';
    idCardUrl: string;
    isFrozen: boolean;
    createdAt: object;
    lastPasswordChange: object;
    lastPinChange: object;
}

interface UserAccount {
    profile: UserProfile;
    wallets: UserWallets;
    security: {
        activeDevice: string;
        operatingSystem: string;
        lastIpAddress: string;
    };
    history: {
        lyd_transactions: object;
        egp_transfers: object;
    };
}

// --- 2. Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ---

/**
 * ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SHA-256
 */
const hashData = (data: string): string => {
    return crypto.createHash('sha256').update(data).digest('hex');
};

// --- 3. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---

/**
 * Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ù„Ø©: createNewUserAccount
 * Ø§Ù„ÙˆØ¸ÙŠÙØ©: Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØµÙÙŠØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸
 */
export const createNewUserAccount = functions.https.onCall(async (data, context) => {
    const { 
        fullName, 
        phoneNumber, 
        password, 
        pin, 
        userType, 
        deviceInfo 
    } = data;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù€ PIN (6 Ø£Ø±Ù‚Ø§Ù…)
    if (!/^\d{6}$/.test(pin)) {
        throw new functions.https.HttpsError('invalid-argument', 'ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙƒÙˆÙ† Ø±Ù…Ø² PIN Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…');
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ UID Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firebase Auth
    const uid = context.auth?.uid;
    if (!uid) {
        throw new functions.https.HttpsError('unauthenticated', 'ÙŠØ¬Ø¨ Ø¥ÙƒÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£ÙˆÙ„Ø§Ù‹');
    }

    const userIP = context.rawRequest.headers['x-forwarded-for'] as string || context.rawRequest.connection.remoteAddress || "Unknown";

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const phoneSnap = await db.ref(`registered_phones/${phoneNumber}`).once('value');
        if (phoneSnap.exists()) {
            throw new functions.https.HttpsError('already-exists', 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù‡Ø°Ø§ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
        }

        // Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒØ§Ø¦Ù† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ Interface Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const userData: UserAccount = {
            profile: {
                fullName: fullName,
                phoneNumber: phoneNumber,
                password: hashData(password),
                pin: hashData(pin),
                userType: userType || "USER",
                verificationStatus: "UNVERIFIED",
                idCardUrl: "",
                isFrozen: false,
                createdAt: admin.database.ServerValue.TIMESTAMP,
                lastPasswordChange: admin.database.ServerValue.TIMESTAMP,
                lastPinChange: admin.database.ServerValue.TIMESTAMP
            },
            wallets: {
                lyd_balance: 0.0,
                egp_balance: 0.0,
                egp_pending_balance: 0.0
            },
            security: {
                activeDevice: deviceInfo || "Unknown",
                operatingSystem: context.rawRequest.headers['user-agent'] || "Unknown",
                lastIpAddress: userIP
            },
            history: {
                lyd_transactions: {},
                egp_transfers: {}
            }
        };

        const batch: { [key: string]: any } = {};
        batch[`users/${uid}`] = userData;
        batch[`registered_phones/${phoneNumber}`] = uid;

        // ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© (Atomic Batch)
        await db.ref().update(batch);

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ØªØ±Ø­ÙŠØ¨ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªÙˆÙƒÙ† Ù…ØªØ§Ø­Ø§Ù‹
        const fcmTokenSnap = await db.ref(`users/${uid}/fcmToken`).once('value');
        if (fcmTokenSnap.exists()) {
            const payload = {
                notification: {
                    title: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! ğŸ‰",
                    body: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ© Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø­Ø³Ø§Ø¨."
                },
                data: { action: "UPLOAD_ID_IMAGE" }
            };
            await admin.messaging().sendToDevice(fcmTokenSnap.val(), payload);
        }

        return { 
            success: true, 
            message: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ù†Ø¸Ø§Ù… TypeScript Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ" 
        };

    } catch (error: any) {
        throw new functions.https.HttpsError('internal', error.message);
    }
});
