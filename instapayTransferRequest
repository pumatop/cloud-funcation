const functions = require('firebase-functions');
const admin = require('firebase-admin');

if (admin.apps.length === 0) {
    admin.initializeApp();
}

/**
 * دالة طلب تحويل InstaPay الأساسية:
 * 1. تعتمد على رقم الهاتف فقط للتحويل.
 * 2. تخصم المبلغ + رسوم خدمة InstaPay من رصيد الجنيه المصري.
 * 3. ترسل الرسوم إلى "إيرادات عمليات انستا باي".
 * 4. تفتح طلباً للمشرف بانتظار رفع إيصال التحويل اليدوي.
 */
exports.instapayTransferRequest = functions.https.onCall(async (data, context) => {
    // التأكد من تسجيل دخول المستخدم
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'يجب تسجيل الدخول أولاً');
    }

    const uid = context.auth.uid;
    const { phoneNumber, amount } = data; // الاعتماد على رقم الهاتف كما طلبت
    const transferAmount = parseFloat(amount);
    const db = admin.database();

    // --- إعدادات حدود ورسوم انستا باي ---
    const MIN_LIMIT = 500;       // أقل مبلغ لتحويل انستا باي
    const MAX_LIMIT = 100000;    // أقصى مبلغ
    const INSTAPAY_FEE = 10.0;   // رسوم الخدمة التي ستذهب للمنصة
    const totalDeduction = transferAmount + INSTAPAY_FEE;

    // 1. التحقق من الحدود
    if (transferAmount < MIN_LIMIT || transferAmount > MAX_LIMIT) {
        throw new functions.https.HttpsError('out-of-range', `حدود تحويل انستا باي من ${MIN_LIMIT} إلى ${MAX_LIMIT} جنيه`);
    }

    try {
        // 2. خصم (المبلغ + الرسوم) من رصيد الجنيه المصري للمستخدم
        const walletRef = db.ref(`users/${uid}/wallets/egp_balance`);
        const transactionResult = await walletRef.transaction((currentBalance) => {
            if (currentBalance === null) return 0;
            if (currentBalance < totalDeduction) return; // فشل الترانزاكشن إذا لم يتوفر الرصيد
            return currentBalance - totalDeduction;
        });

        if (!transactionResult.committed) {
            throw new functions.https.HttpsError('failed-precondition', 'رصيدك لا يكفي للمبلغ المطلوب ورسوم انستا باي');
        }

        // 3. توجيه الرسوم إلى إيرادات المنصة (قسم انستا باي)
        await db.ref('metadata/revenue/instapay_fees').transaction(c => (c || 0) + INSTAPAY_FEE);

        // 4. إنشاء طلب تحويل معلق للمشرف
        const requestRef = db.ref('admin_tasks/instapay_orders').push();
        const requestId = requestRef.key;

        await requestRef.set({
            requestId: requestId,
            userUid: uid,
            targetPhone: phoneNumber,
            amount: transferAmount,
            fee: INSTAPAY_FEE,
            status: 'WAITING_FOR_ADMIN_RECEIPT', // الحالة: بانتظار إيصال المشرف
            timestamp: admin.database.ServerValue.TIMESTAMP
        });

        // 5. إضافة العملية لسجل المستخدم كعملية "تحت التنفيذ"
        await db.ref(`users/${uid}/instapay_history/${requestId}`).set({
            phoneNumber: phoneNumber,
            amount: transferAmount,
            status: 'PROCESSING',
            timestamp: admin.database.ServerValue.TIMESTAMP
        });

        return { 
            success: true, 
            message: "تم إرسال طلب انستا باي. سيقوم المشرف بالتحويل ورفع الإيصال قريباً" 
        };

    } catch (error) {
        console.error("Instapay Error:", error);
        throw new functions.https.HttpsError('internal', 'حدث خطأ في معالجة طلب انستا باي');
    }
});
