import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';
import * as crypto from 'crypto';

// --- ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ (Interfaces) ---

interface FeeTier {
    min: number;
    max: number;
    fee: number;
}

interface TransferSettings {
    minTransferLyd: number;
    maxTransferLyd: number;
    transfer_lyd_fees: FeeTier[];
}

/**
 * Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù† Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ) 
 * Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ ÙˆØªØªØ¨Ø¹ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
 */
export const transferLydUserToUser = functions.https.onCall(async (data, context) => {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    }

    const senderUid = context.auth.uid;
    const { receiverPhone, amount, pin }: { receiverPhone: string, amount: number, pin: string } = data;
    const db = admin.database();

    try {
        // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø±Ø§Ø³Ù„ØŒ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ØªÙ„Ù…ØŒ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)
        const [senderSnap, receiverPhoneSnap, settingsSnap] = await Promise.all([
            db.ref(`users/${senderUid}`).once('value'),
            db.ref(`registered_phones/${receiverPhone}`).once('value'),
            db.ref('settings').once('value')
        ]);

        if (!senderSnap.exists()) throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø§Ø³Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
        const senderData = senderSnap.val();
        const settings = settingsSnap.val() as TransferSettings;

        // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ù…Ù†ÙŠØ©
        if (senderData.profile.isFrozen) {
            throw new functions.https.HttpsError('permission-denied', 'Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¬Ù…Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­ÙˆÙŠÙ„');
        }

        const hashedPin = crypto.createHash('sha256').update(pin).digest('hex');
        if (hashedPin !== senderData.profile.pin) {
            throw new functions.https.HttpsError('permission-denied', 'Ø±Ù…Ø² PIN ØºÙŠØ± ØµØ­ÙŠØ­');
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ„Ù…
        if (!receiverPhoneSnap.exists()) {
            throw new functions.https.HttpsError('not-found', 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
        }
        const receiverUid = receiverPhoneSnap.val();
        if (senderUid === receiverUid) {
            throw new functions.https.HttpsError('invalid-argument', 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù†ÙØ³Ùƒ');
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        if (amount < settings.minTransferLyd || amount > settings.maxTransferLyd) {
            throw new functions.https.HttpsError('out-of-range', 
                `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ Ø¨ÙŠÙ† ${settings.minTransferLyd} Ùˆ ${settings.maxTransferLyd} Ø¯ÙŠÙ†Ø§Ø±`);
        }

        // 4. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø³ÙˆÙ… Ø­Ø³Ø¨ Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ (Tiers)
        const tier = settings.transfer_lyd_fees.find(t => amount >= t.min && amount <= t.max);
        const serviceFee = tier ? tier.fee : 0;
        const totalDeduction = amount + serviceFee;

        if (senderData.wallets.lyd_balance < totalDeduction) {
            throw new functions.https.HttpsError('insufficient-funds', 'Ø±ØµÙŠØ¯Ùƒ Ù„Ø§ ÙŠÙƒÙÙŠ Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„Ø±Ø³ÙˆÙ…');
        }

        // 5. Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ (Atomic Update)
        const now = new Date();
        const dayKey = now.toISOString().split('T')[0];
        const monthKey = dayKey.substring(0, 7);

        const updates: { [key: string]: any } = {};

        // Ø®ØµÙ… Ù…Ù† Ø§Ù„Ø±Ø§Ø³Ù„ ÙˆØ¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø³ØªÙ„Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… increment Ù„Ù„Ø£Ù…Ø§Ù†
        updates[`users/${senderUid}/wallets/lyd_balance`] = admin.database.ServerValue.increment(-totalDeduction);
        updates[`users/${receiverUid}/wallets/lyd_balance`] = admin.database.ServerValue.increment(amount);

        // ØªØ³Ø¬ÙŠÙ„ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØµØ© (ØªØ±Ø§ÙƒÙ…ÙŠ)
        updates[`stats/revenue/lyd_transfers/daily/${dayKey}`] = admin.database.ServerValue.increment(serviceFee);
        updates[`stats/revenue/lyd_transfers/monthly/${monthKey}`] = admin.database.ServerValue.increment(serviceFee);
        updates[`stats/revenue/lyd_transfers/total_all_time`] = admin.database.ServerValue.increment(serviceFee);

        // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
        const transferKey = db.ref('transfer_logs').push().key;
        const transactionDetail = {
            sender: senderUid,
            receiver: receiverUid,
            amount: amount,
            fee: serviceFee,
            currency: "LYD",
            timestamp: admin.database.ServerValue.TIMESTAMP
        };

        updates[`users/${senderUid}/history/lyd_transactions/${transferKey}`] = { ...transactionDetail, direction: "OUTGOING" };
        updates[`users/${receiverUid}/history/lyd_transactions/${transferKey}`] = { ...transactionDetail, direction: "INCOMING" };

        await db.ref().update(updates);

        // 6. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
        const receiverTokenSnap = await db.ref(`users/${receiverUid}/fcmToken`).once('value');
        
        // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø±Ø§Ø³Ù„
        if (senderData.fcmToken) {
            await admin.messaging().sendToDevice(senderData.fcmToken, {
                notification: { 
                    title: "ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…", 
                    body: `Ø£Ø±Ø³Ù„Øª ${amount} Ø¯ÙŠÙ†Ø§Ø± Ø¥Ù„Ù‰ ${receiverPhone}. Ø§Ù„Ø±Ø³ÙˆÙ…: ${serviceFee}` 
                }
            });
        }

        // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ„Ù…
        if (receiverTokenSnap.exists()) {
            await admin.messaging().sendToDevice(receiverTokenSnap.val(), {
                notification: { 
                    title: "Ø§Ø³ØªÙ„Ø§Ù… Ø±ØµÙŠØ¯ Ø¬Ø¯ÙŠØ¯ ğŸ’°", 
                    body: `ÙˆØµÙ„Ùƒ Ù…Ø¨Ù„Øº ${amount} Ø¯ÙŠÙ†Ø§Ø± Ù…Ù† ${senderData.profile.phoneNumber}` 
                }
            });
        }

        return { success: true, transactionId: transferKey };

    } catch (error: any) {
        console.error("Transfer Error:", error);
        if (error instanceof functions.https.HttpsError) throw error;
        throw new functions.https.HttpsError('internal', error.message);
    }
});
