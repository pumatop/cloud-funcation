const functions = require('firebase-functions');
const admin = require('firebase-admin');
const crypto = require('crypto');

/**
 * Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù† Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ) Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ
 */
exports.transferLydUserToUser = functions.https.onCall(async (data, context) => {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    if (!context.auth) throw new functions.https.HttpsError('unauthenticated', 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    
    const senderUid = context.auth.uid;
    const { receiverPhone, amount, pin } = data; // Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ØªÙ„Ù…ØŒ Ø§Ù„Ù…Ø¨Ù„ØºØŒ ÙˆØ§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ
    const db = admin.database();

    try {
        // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ø±Ø§Ø³Ù„ØŒ Ø§Ù„Ù…Ø³ØªÙ„Ù…ØŒ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØµØ©)
        const [senderSnap, receiverPhoneSnap, settingsSnap] = await Promise.all([
            db.ref(`users/${senderUid}`).once('value'),
            db.ref(`registered_phones/${receiverPhone}`).once('value'),
            db.ref('settings/transfer_lyd_fees').once('value') // Ø¬Ù„Ø¨ Ø´Ø±Ø§Ø¦Ø­ Ø§Ù„Ø±Ø³ÙˆÙ…
        ]);

        const senderData = senderSnap.val();
        const settings = (await db.ref('settings').once('value')).val();

        // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ù…Ù†ÙŠØ© ÙˆØ§Ù„Ù‚ÙŠÙˆØ¯
        if (senderData.profile.isFrozen) throw new functions.https.HttpsError('permission-denied', 'Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¬Ù…Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù€ PIN Ø§Ù„Ù…Ø´ÙØ±
        if (crypto.createHash('sha256').update(pin).digest('hex') !== senderData.profile.pin) {
            throw new functions.https.HttpsError('permission-denied', 'Ø±Ù…Ø² PIN ØºÙŠØ± ØµØ­ÙŠØ­');
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù…
        if (!receiverPhoneSnap.exists()) throw new functions.https.HttpsError('not-found', 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
        const receiverUid = receiverPhoneSnap.val();
        if (senderUid === receiverUid) throw new functions.https.HttpsError('invalid-argument', 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù†ÙØ³Ùƒ');

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©
        if (amount < settings.minTransferLyd || amount > settings.maxTransferLyd) {
            throw new functions.https.HttpsError('out-of-range', `Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† ${settings.minTransferLyd} Ùˆ ${settings.maxTransferLyd}`);
        }

        // 4. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø³ÙˆÙ… Ø­Ø³Ø¨ Ø§Ù„Ø´Ø±ÙŠØ­Ø© (Tiers)
        // Ù†ÙØªØ±Ø¶ Ø£Ù† settings.transfer_lyd_fees Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ€ [{min: 0, max: 100, fee: 2}, ...]
        const feeTiers = settings.transfer_lyd_fees || [];
        const tier = feeTiers.find(t => amount >= t.min && amount <= t.max);
        const serviceFee = tier ? tier.fee : 0;
        const totalDeduction = amount + serviceFee;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙØ§ÙŠØ© Ø§Ù„Ø±ØµÙŠØ¯ (Ø§Ù„Ù…Ø¨Ù„Øº + Ø§Ù„Ø±Ø³ÙˆÙ…)
        if (senderData.wallets.lyd_balance < totalDeduction) {
            throw new functions.https.HttpsError('insufficient-funds', 'Ø±ØµÙŠØ¯Ùƒ Ù„Ø§ ÙŠÙƒÙÙŠ Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„Ø±Ø³ÙˆÙ…');
        }

        // 5. Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø°Ø±ÙŠ (Database Update)
        const now = new Date();
        const dayKey = now.toISOString().split('T')[0]; // YYYY-MM-DD
        const monthKey = dayKey.substring(0, 7); // YYYY-MM

        const updates = {};

        // Ø®ØµÙ… Ù…Ù† Ø§Ù„Ø±Ø§Ø³Ù„ ÙˆØ¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø³ØªÙ„Ù…
        updates[`users/${senderUid}/wallets/lyd_balance`] = admin.database.ServerValue.increment(-totalDeduction);
        updates[`users/${receiverUid}/wallets/lyd_balance`] = admin.database.ServerValue.increment(amount);

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³ÙˆÙ… Ù„Ø­Ø³Ø§Ø¨ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØµØ© Ø¨Ø´ÙƒÙ„ ØªØ±Ø§ÙƒÙ…ÙŠ
        updates[`stats/revenue/lyd_transfers/daily/${dayKey}`] = admin.database.ServerValue.increment(serviceFee);
        updates[`stats/revenue/lyd_transfers/monthly/${monthKey}`] = admin.database.ServerValue.increment(serviceFee);
        updates[`stats/revenue/lyd_transfers/total_all_time`] = admin.database.ServerValue.increment(serviceFee);

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø·Ø±ÙÙŠÙ†
        const transferKey = db.ref('transfer_logs').push().key;
        const transactionDetail = {
            sender: senderUid,
            receiver: receiverUid,
            amount: amount,
            fee: serviceFee,
            currency: "LYD",
            timestamp: admin.database.ServerValue.TIMESTAMP
        };

        updates[`users/${senderUid}/history/lyd_transactions/${transferKey}`] = { ...transactionDetail, direction: "OUTGOING" };
        updates[`users/${receiverUid}/history/lyd_transactions/${transferKey}`] = { ...transactionDetail, direction: "INCOMING" };

        await db.ref().update(updates);

        // 6. Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù„Ø­Ø¸ÙŠØ©
        const receiverData = (await db.ref(`users/${receiverUid}/fcmToken`).once('value')).val();
        const senderToken = senderData.fcmToken;

        if (senderToken) {
            await admin.messaging().sendToDevice(senderToken, {
                notification: { title: "ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…", body: `Ø£Ø±Ø³Ù„Øª ${amount} Ø¯ÙŠÙ†Ø§Ø± Ø¥Ù„Ù‰ ${receiverPhone}. Ø§Ù„Ø±Ø³ÙˆÙ…: ${serviceFee}` }
            });
        }

        if (receiverData) {
            await admin.messaging().sendToDevice(receiverData, {
                notification: { title: "Ø§Ø³ØªÙ„Ø§Ù… Ø±ØµÙŠØ¯ Ø¬Ø¯ÙŠØ¯ ğŸ’°", body: `ÙˆØµÙ„Ùƒ Ù…Ø¨Ù„Øº ${amount} Ø¯ÙŠÙ†Ø§Ø± Ù…Ù† ${senderData.profile.phoneNumber}` }
            });
        }

        return { success: true, transactionId: transferKey };

    } catch (e) {
        throw new functions.https.HttpsError('internal', e.message);
    }
});


//Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø©:
Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ (Fee Tiers): ØªØ¨Ø­Ø« Ø§Ù„Ø¯Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù† Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø®Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ "Ø´Ø±Ø§Ø¦Ø­" ØªØ¶Ø¨Ø·Ù‡Ø§ Ø£Ù†Øª ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.

Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©: ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ "Ù‚Ø±Ø´" Ø±Ø³ÙˆÙ… ÙÙŠ Ù…Ø³Ø§Ø± Ø¥Ø­ØµØ§Ø¦ÙŠ Ø®Ø§Øµ (daily Ùˆ monthly) Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø±Ø¤ÙŠØ© Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ù†ØµØ© Ù…Ù† Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª Ø§Ù„Ù„ÙŠØ¨ÙŠØ© ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….

Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡Ø§ØªÙ: Ø§Ù„Ø¯Ø§Ù„Ø© ØªÙ…Ù†Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø£Ø±Ù‚Ø§Ù… ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ø£Ùˆ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù†ÙØ³.

Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬: Ù„Ø§ ØªÙƒØªÙ…Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ù„Ø§ Ø¨ØµØ­Ø© Ø§Ù„Ù€ PIN ÙˆØ¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ "ØªØ¬Ù…ÙŠØ¯" Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø³Ø§Ø¨.

Ø³Ø¬Ù„Ø§Øª Ù…Ø²Ø¯ÙˆØ¬Ø©: ØªØ¸Ù‡Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø±Ø§Ø³Ù„ ÙƒÙ€ (Ø®ØµÙ…) ÙˆÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªÙ„Ù… ÙƒÙ€ (Ø¥Ø¶Ø§ÙØ©) Ù…Ø¹ ÙƒØ§Ù…Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„.
