const functions = require('firebase-functions');
const admin = require('firebase-admin');
const axios = require('axios'); // تأكد من تنصيب axios للتعامل مع الـ API الخارجي

if (admin.apps.length === 0) {
    admin.initializeApp();
}

/**
 * دالة شراء كروت الشحن:
 * 1. التأكد من رصيد المستخدم (بالدينار الليبي).
 * 2. طلب كارت الشحن من الـ API الخارجي.
 * 3. خصم القيمة من المستخدم وإضافتها لمبيعات المنصة.
 * 4. إرسال كود الشحن للمستخدم.
 */
exports.purchaseTelecomCard = functions.https.onCall(async (data, context) => {
    // 1. التحقق من تسجيل الدخول
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'يجب تسجيل الدخول أولاً');
    }

    const uid = context.auth.uid;
    const { cardType, cardPrice } = data; // نوع الكرت وسعره (مثلاً: مدار 5 دينار)
    const db = admin.database();

    try {
        // 2. عملية خصم الرصيد أولاً (لضمان وجود سيولة)
        const userWalletRef = db.ref(`users/${uid}/wallets/lyd_balance`);
        const transactionResult = await userWalletRef.transaction((currentBalance) => {
            if (currentBalance === null) return 0;
            if (currentBalance < cardPrice) return; // رصيد غير كافٍ
            return currentBalance - cardPrice;
        });

        if (!transactionResult.committed) {
            throw new functions.https.HttpsError('failed-precondition', 'رصيدك غير كافٍ لإتمام عملية الشراء');
        }

        // 3. الاتصال بـ API المزود الخارجي لجلب الكرت
        // ملاحظة: استبدل الرابط والمفاتيح ببيانات المزود الخاص بك
        const apiResponse = await axios.post('https://api.provider.com/get-card', {
            apiKey: 'YOUR_SECRET_API_KEY',
            type: cardType,
            value: cardPrice
        });

        const cardPin = apiResponse.data.pin_code; // كود الشحن المستلم من الـ API

        // 4. تحديث مبيعات المنصة (إحصائيات المبيعات التراكمية)
        const updates = {};
        updates[`metadata/total_card_sales_lyd`] = admin.database.ServerValue.increment(cardPrice);
        updates[`metadata/cards_sold_count`] = admin.database.ServerValue.increment(1);
        
        // 5. تسجيل العملية في سجلات المستخدم مع كود الكرت
        const logRef = db.ref(`users/${uid}/orders`).push();
        await logRef.set({
            item: `${cardType} ${cardPrice} LYD`,
            pin: cardPin,
            price: cardPrice,
            status: 'SUCCESS',
            timestamp: admin.database.ServerValue.TIMESTAMP
        });

        await db.ref().update(updates);

        return { 
            success: true, 
            pin: cardPin, 
            message: "تم الشراء بنجاح، كود الشحن موجود في سجل طلباتك" 
        };

    } catch (error) {
        console.error("Purchase Error:", error);
        
        // في حال فشل الـ API بعد خصم الرصيد، يجب إعادة الرصيد للمستخدم (Rollback)
        if (error.response || error.request) {
            await db.ref(`users/${uid}/wallets/lyd_balance`).transaction(c => (c || 0) + cardPrice);
        }

        throw new functions.https.HttpsError('internal', 'حدث خطأ في الاتصال بالمزود، تم إعادة الرصيد لحسابك');
    }
});
