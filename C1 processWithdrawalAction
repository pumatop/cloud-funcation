import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';

/**
 * دالة معالجة طلبات السحب (تأكيد أو رفض)
 * الوظيفة: إنهاء التعليق المالي إما بالخصم النهائي أو بإعادة الرصيد للمحفظة
 */
export const processWithdrawalRequest = functions.https.onCall(async (data, context) => {
    // 1. التحقق من المصادقة وصلاحية المسؤول/المندوب
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'يجب تسجيل الدخول أولاً');
    }

    const adminUid = context.auth.uid;
    const { requestId, action, reason, receiptUrl }: 
    { requestId: string, action: 'APPROVE' | 'REJECT', reason?: string, receiptUrl?: string } = data;
    
    const db = admin.database();

    try {
        // 2. جلب البيانات والتحقق من الصلاحيات
        const [adminSnap, requestSnap] = await Promise.all([
            db.ref(`users/${adminUid}/profile/userType`).once('value'),
            db.ref(`withdraw_requests/${requestId}`).once('value')
        ]);

        const userRole = adminSnap.val();
        if (userRole !== 'ADMIN' && userRole !== 'DELEGATE') {
            throw new functions.https.HttpsError('permission-denied', 'ليس لديك صلاحية معالجة هذا الطلب');
        }

        if (!requestSnap.exists()) {
            throw new functions.https.HttpsError('not-found', 'طلب السحب غير موجود');
        }

        const requestData = requestSnap.val();
        if (requestData.status !== 'PENDING_MANUAL_TRANSFER') {
            throw new functions.https.HttpsError('failed-precondition', 'هذا الطلب تمت معالجته مسبقاً');
        }

        const userUid = requestData.senderUid;
        const totalAmount = requestData.amount + requestData.fee;
        const updates: { [key: string]: any } = {};
        const now = admin.database.ServerValue.TIMESTAMP;

        // 3. منطق المعالجة بناءً على نوع الإجراء (Action)
        
        if (action === 'APPROVE') {
            // --- مسار التأكيد (Approval Path) ---
            if (requestData.requiresReceipt && !receiptUrl) {
                throw new functions.https.HttpsError('invalid-argument', 'يجب إرفاق صورة الإيصال للتأكيد');
            }

            // خصم نهائي من الرصيد المعلق
            updates[`users/${userUid}/wallets/egp_pending_balance`] = admin.database.ServerValue.increment(-totalAmount);
            
            // تحديث البيانات
            const approvalDetails = {
                status: "COMPLETED",
                completedBy: adminUid,
                receiptUrl: receiptUrl || "N/A",
                processedAt: now
            };
            Object.assign(updates, createUpdatePaths(requestId, userUid, requestData, approvalDetails));

        } else if (action === 'REJECT') {
            // --- مسار الرفض (Rejection Path) ---
            if (!reason || reason.trim().length < 3) {
                throw new functions.https.HttpsError('invalid-argument', 'يجب ذكر سبب الرفض');
            }

            // إعادة المال: خصم من المعلق وإضافة للمتاح
            updates[`users/${userUid}/wallets/egp_pending_balance`] = admin.database.ServerValue.increment(-totalAmount);
            updates[`users/${userUid}/wallets/egp_balance`] = admin.database.ServerValue.increment(totalAmount);

            // تصحيح الإيرادات (خصم الرسوم التي لن تُحصّل)
            const dayKey = new Date(requestData.timestamp).toISOString().split('T')[0];
            updates[`stats/revenue/egp_fees/daily/${dayKey}`] = admin.database.ServerValue.increment(-requestData.fee);

            const rejectionDetails = {
                status: "REJECTED",
                rejectedBy: adminUid,
                rejectReason: reason,
                processedAt: now
            };
            Object.assign(updates, createUpdatePaths(requestId, userUid, requestData, rejectionDetails));

        } else {
            throw new functions.https.HttpsError('invalid-argument', 'إجراء غير صالح');
        }

        // 4. تنفيذ التحديثات الذرية
        await db.ref().update(updates);

        // 5. إرسال الإشعار المناسب للمستخدم
        const userTokenSnap = await db.ref(`users/${userUid}/fcmToken`).once('value');
        if (userTokenSnap.exists()) {
            const title = action === 'APPROVE' ? "تم تنفيذ سحبك ✅" : "تم رفض طلب السحب ❌";
            const body = action === 'APPROVE' 
                ? `وصلك مبلغ ${requestData.amount} ج.م. تفقد حسابك الآن.` 
                : `تم رفض طلبك لسبب: ${reason}. وعاد الرصيد لمحفظتك.`;
            
            await admin.messaging().sendToDevice(userTokenSnap.val(), { notification: { title, body } });
        }

        return { success: true, action: action };

    } catch (error: any) {
        console.error("Process Withdrawal Error:", error);
        if (error instanceof functions.https.HttpsError) throw error;
        throw new functions.https.HttpsError('internal', error.message);
    }
});

/**
 * دالة مساعدة لتوليد مسارات التحديث المتكررة
 */
function createUpdatePaths(reqId: string, uId: string, oldData: any, details: any) {
    const finalObj = { ...oldData, ...details };
    return {
        [`withdraw_requests/${reqId}`]: finalObj,
        [`users/${uId}/history/withdrawals/${reqId}`]: finalObj,
        [`stats/logs/all_withdrawals/${reqId}`]: finalObj
    };
}
