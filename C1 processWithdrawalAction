const functions = require('firebase-functions');
const admin = require('firebase-admin');

/**
 * دالة معالجة طلبات السحب (تأكيد أو رفض)
 * اسم الدالة: processWithdrawalAction
 */
exports.processWithdrawalAction = functions.https.onCall(async (data, context) => {
    // 1. التحقق من الصلاحية
    if (!context.auth) throw new functions.https.HttpsError('unauthenticated', 'يجب تسجيل الدخول');
    
    const executorUid = context.auth.uid; // المندوب أو الأدمن المنفذ
    const { requestId, action, receiptUrl, rejectReason } = data; // action: 'CONFIRM' or 'REJECT'
    const db = admin.database();

    try {
        // 2. جلب بيانات الطلب من قاعدة البيانات
        const requestSnap = await db.ref(`withdraw_requests/${requestId}`).once('value');
        if (!requestSnap.exists()) throw new functions.https.HttpsError('not-found', 'الطلب غير موجود');

        const requestData = requestSnap.val();
        const userUid = requestData.senderUid;
        const totalAmount = requestData.amount + requestData.fee;

        // التحقق من أن الطلب لا يزال في حالة "انتظار التنفيذ اليدوي"
        if (requestData.status !== "PENDING_MANUAL_TRANSFER") {
            throw new functions.https.HttpsError('failed-precondition', 'تمت معالجة هذا الطلب مسبقاً');
        }

        const now = new Date();
        const dayKey = now.toISOString().split('T')[0];
        const monthKey = dayKey.substring(0, 7);
        const updates = {};

        // 3. معالجة الطلب بناءً على نوع الإجراء (Action)
        
        if (action === 'CONFIRM') {
            // --- حالة التأكيد (التنفيذ بنجاح) ---
            
            // التحقق من الإيصال للمحافظ وانستاباي
            if (requestData.requiresReceipt && !receiptUrl) {
                throw new functions.https.HttpsError('invalid-argument', 'يجب رفع صورة الإيصال لتأكيد التحويل');
            }

            // خصم المبلغ نهائياً من الحساب المعلق
            updates[`users/${userUid}/wallets/egp_pending_balance`] = admin.database.ServerValue.increment(-totalAmount);

            // تحديث بيانات الطلب
            const finalData = {
                ...requestData,
                status: "COMPLETED",
                executedBy: executorUid,
                receiptUrl: receiptUrl || "N/A",
                completedAt: admin.database.ServerValue.TIMESTAMP
            };
            updates[`withdraw_requests/${requestId}`] = finalData;
            updates[`users/${userUid}/history/withdrawals/${requestId}`] = finalData;

            // تحديث إحصائيات المندوب التراكمية
            updates[`users/${executorUid}/stats/executed_withdrawals_count`] = admin.database.ServerValue.increment(1);
            updates[`users/${executorUid}/stats/total_executed_amount`] = admin.database.ServerValue.increment(requestData.amount);

            // إشعار المستخدم بالنجاح
            await sendNotification(userUid, "تم التحويل بنجاح ✅", `تم تنفيذ طلبك بقيمة ${requestData.amount} ج.م.`);

        } else if (action === 'REJECT') {
            // --- حالة الرفض والإرجاع ---

            // إعادة المبلغ والرسوم لرصيد المستخدم المتاح وخصمه من المعلق
            updates[`users/${userUid}/wallets/egp_balance`] = admin.database.ServerValue.increment(totalAmount);
            updates[`users/${userUid}/wallets/egp_pending_balance`] = admin.database.ServerValue.increment(-totalAmount);

            // تحديث بيانات الطلب إلى مرفوض
            const rejectedData = {
                ...requestData,
                status: "REJECTED",
                rejectedBy: executorUid,
                reason: rejectReason || "لم يتم ذكر سبب",
                rejectedAt: admin.database.ServerValue.TIMESTAMP
            };
            updates[`withdraw_requests/${requestId}`] = rejectedData;
            updates[`users/${userUid}/history/withdrawals/${requestId}`] = rejectedData;

            // عكس إيرادات الرسوم التراكمية (خصمها لأن العملية لم تتم)
            updates[`stats/revenue/egp_fees/daily/${dayKey}`] = admin.database.ServerValue.increment(-requestData.fee);
            updates[`stats/revenue/egp_fees/monthly/${monthKey}`] = admin.database.ServerValue.increment(-requestData.fee);

            // إشعار المستخدم بالرفض
            await sendNotification(userUid, "تم رفض طلب السحب ❌", `تم إرجاع المبلغ لحسابك. السبب: ${rejectReason}`);

        } else {
            throw new functions.https.HttpsError('invalid-argument', 'إجراء غير مدعوم');
        }

        // 4. تنفيذ جميع التحديثات مرة واحدة (Atomic Update)
        await db.ref().update(updates);
        return { success: true, message: `تم تنفيذ الإجراء (${action}) بنجاح` };

    } catch (e) {
        throw new functions.https.HttpsError('internal', e.message);
    }
});

/**
 * دالة مساعدة لإرسال الإشعارات
 */
async function sendNotification(uid, title, body) {
    const userTokenSnap = await admin.database().ref(`users/${uid}/fcmToken`).once('value');
    if (userTokenSnap.exists()) {
        await admin.messaging().sendToDevice(userTokenSnap.val(), {
            notification: { title, body }
        });
    }
}

//الذكاء في الإيرادات: في حالة التأكيد، تبقى الرسوم المسجلة مسبقاً كما هي. أما في حالة الرفض، تقوم الدالة تلقائياً بخصم (عكس) قيمة الرسوم من السجلات التراكمية اليومية والشهرية لضمان دقة أرباح المنصة.

إدارة الرصيد المعلق: في كلتا الحالتين (تأكيد أو رفض)، يتم تصفير المبلغ من محفظة egp_pending_balance للمستخدم، إما بالخصم النهائي أو بالإرجاع للمحفظة الأساسية.

توثيق كامل: تسجل الدالة من قام بالإجراء (executedBy أو rejectedBy) وتُحدث إحصائيات المندوب فقط في حالة التنفيذ الناجح.

أمان الإيصال: لا تزال القاعدة الصارمة موجودة؛ لا يمكن "التأكيد" لعمليات المحافظ وانستاباي بدون رابط receiptUrl.
