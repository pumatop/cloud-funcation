import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';

/**
 * دالة تجميد أو إلغاء تجميد الحساب (TypeScript)
 * الوظيفة: التحكم في حالة دخول المستخدم وقدرته على إجراء العمليات الممالية
 */
export const toggleAccountFreeze = functions.https.onCall(async (data, context) => {
    // 1. التحقق من المصادقة الأساسية
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'يجب تسجيل الدخول أولاً');
    }

    const adminUid = context.auth.uid;
    const { targetUid, freezeStatus, reason }: { targetUid: string, freezeStatus: boolean, reason?: string } = data;
    const db = admin.database();

    try {
        // 2. التحقق من صلاحية الأدمن (باستخدام المسار الموحد profile/userType)
        const adminSnap = await db.ref(`users/${adminUid}/profile/userType`).once('value');
        if (adminSnap.val() !== 'ADMIN') {
            throw new functions.https.HttpsError('permission-denied', 'هذا الإجراء مخصص للمسؤولين فقط');
        }

        // 3. التحقق من وجود المستخدم المستهدف
        const userSnap = await db.ref(`users/${targetUid}`).once('value');
        if (!userSnap.exists()) {
            throw new functions.https.HttpsError('not-found', 'المستخدم المستهدف غير موجود');
        }

        // 4. إعداد التحديثات (Updates Object)
        const updates: { [key: string]: any } = {
            'profile/isFrozen': freezeStatus,
            'profile/freezeReason': freezeStatus ? (reason || "مخالفة شروط الاستخدام") : null,
            'metadata/lastStatusChange': admin.database.ServerValue.TIMESTAMP
        };

        await db.ref(`users/${targetUid}`).update(updates);

        // 5. في حالة التجميد: طرد المستخدم من جميع الجلسات النشطة فوراً
        if (freezeStatus) {
            await admin.auth().revokeRefreshTokens(targetUid);
        }

        // 6. نظام الإشعارات (FCM)
        const fcmTokenSnap = await db.ref(`users/${targetUid}/fcmToken`).once('value');
        if (fcmTokenSnap.exists()) {
            const payload: admin.messaging.MessagingPayload = {
                notification: {
                    title: freezeStatus ? "تنبيه: تم تجميد الحساب ⚠️" : "تم إعادة تفعيل حسابك ✅",
                    body: freezeStatus 
                        ? `تم تجميد حسابك للسبب التالي: ${reason}. يرجى التواصل مع الدعم.` 
                        : "تم فك تجميد حسابك، يمكنك الآن العودة لاستخدام التطبيق.",
                    sound: "default"
                }
            };
            await admin.messaging().sendToDevice(fcmTokenSnap.val(), payload);
        }

        return { 
            success: true, 
            message: freezeStatus ? "تم تجميد الحساب وطرد الجلسات" : "تم إلغاء التجميد بنجاح" 
        };

    } catch (error: any) {
        console.error("Freeze Toggle Error:", error);
        if (error instanceof functions.https.HttpsError) throw error;
        throw new functions.https.HttpsError('internal', error.message);
    }
});
