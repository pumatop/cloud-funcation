import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';
import * as crypto from 'crypto';

/**
 * Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª SHA-256
 */
const hashData = (data: string): string => {
    return crypto.createHash('sha256').update(data).digest('hex');
};

/**
 * Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø±Ù…Ø² Ø§Ù„Ù€ PIN Ù…Ø¹ Ø´Ø±ÙˆØ· Ø®Ø§ØµØ© Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø³ÙŠØ§Ù† (TypeScript)
 */
export const updateUserPIN = functions.https.onCall(async (data, context) => {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    }

    const uid = context.auth.uid;
    const { oldPin, newPin, resetCode, method } = data; 
    // method: 'OLD_PIN' | 'RESET_CODE'
    
    const db = admin.database();

    try {
        const userRef = db.ref(`users/${uid}`);
        const snapshot = await userRef.once('value');
        
        if (!snapshot.exists()) {
            throw new functions.https.HttpsError('not-found', 'Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        }

        const userData = snapshot.val();

        // --- Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ù„ØªØºÙŠÙŠØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø¨Ø¯ÙˆÙ† Ù‚ÙŠÙˆØ¯ Ø²Ù…Ù†ÙŠØ©) ---
        if (method === 'OLD_PIN') {
            if (!oldPin) throw new functions.https.HttpsError('invalid-argument', 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² PIN Ø§Ù„Ù‚Ø¯ÙŠÙ…');
            
            if (hashData(oldPin) !== userData.profile.pin) {
                throw new functions.https.HttpsError('permission-denied', 'Ø±Ù…Ø² PIN Ø§Ù„Ù‚Ø¯ÙŠÙ… ØºÙŠØ± ØµØ­ÙŠØ­');
            }
        } 
        
        // --- Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø§Ù„ØªØºÙŠÙŠØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ (Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø³ÙŠØ§Ù† - Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙˆØ¯) ---
        else if (method === 'RESET_CODE') {
            if (!resetCode) throw new functions.https.HttpsError('invalid-argument', 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚');

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø´Ø±Ø· Ø§Ù„Ù€ 24 Ø³Ø§Ø¹Ø© Ù…Ù† ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            const lastPassChange: number = userData.profile.lastPasswordChange || 0;
            const currentTime: number = Date.now();
            const twentyFourHours: number = 24 * 60 * 60 * 1000;

            if (currentTime - lastPassChange < twentyFourHours) {
                // ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙˆØ±Ø§Ù‹ Ø¨Ø³Ø¨Ø¨ Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ø£Ù…Ù†ÙŠ (ÙØ® Ø§Ù„Ø£Ù…Ø§Ù†)
                await userRef.child('profile').update({
                    isFrozen: true,
                    freezeReason: "Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© PIN Ù‚Ø¨Ù„ Ù…Ø±ÙˆØ± 24 Ø³Ø§Ø¹Ø© Ø¹Ù„Ù‰ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
                    freezeUntil: currentTime + twentyFourHours
                });
                
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ù…Ù† ÙƒØ§ÙØ© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
                await admin.auth().revokeRefreshTokens(uid);

                throw new functions.https.HttpsError('permission-denied', 'Ø£Ù…Ù†ÙŠØ§Ù‹: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯Ø© PIN Ø§Ù„Ù…Ù†Ø³ÙŠ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ù…Ø±ÙˆØ± 24 Ø³Ø§Ø¹Ø© Ø¹Ù„Ù‰ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±. ØªÙ… ØªØ¬Ù…ÙŠØ¯ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¤Ù‚ØªØ§Ù‹.');
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ (resetCode)
            const tempCodeSnap = await db.ref(`temp_codes/${uid}/pin_reset`).once('value');
            if (!tempCodeSnap.exists() || tempCodeSnap.val() !== resetCode) {
                throw new functions.https.HttpsError('permission-denied', 'ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
            }
            
            // Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
            await db.ref(`temp_codes/${uid}/pin_reset`).remove();
        } 
        else {
            throw new functions.https.HttpsError('invalid-argument', 'ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØºÙŠÙŠØ± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
        }

        // 3. Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø§Ù„ØªØ´ÙÙŠØ± ÙˆØ­ÙØ¸ ÙˆÙ‚Øª Ø§Ù„ØªØºÙŠÙŠØ±)
        const hashedPin = hashData(newPin);
        await userRef.child('profile').update({
            pin: hashedPin,
            lastPinChange: admin.database.ServerValue.TIMESTAMP
        });

        // 4. Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù‚ØµÙˆÙ‰: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† ÙƒØ§ÙØ© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
        await admin.auth().revokeRefreshTokens(uid);

        // 5. Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø£Ù…Ù†ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const fcmTokenSnap = await db.ref(`users/${uid}/fcmToken`).once('value');
        if (fcmTokenSnap.exists()) {
            const payload: admin.messaging.MessagingPayload = {
                notification: {
                    title: "ØªØ­Ø¯ÙŠØ« Ø£Ù…Ù†ÙŠ ğŸ›¡ï¸",
                    body: "ØªÙ… ØªØºÙŠÙŠØ± Ø±Ù…Ø² PIN Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø®Ø±Ù‰ Ù„Ø¶Ù…Ø§Ù† Ø£Ù…Ø§Ù† Ø£Ù…ÙˆØ§Ù„Ùƒ.",
                    sound: "default"
                }
            };
            await admin.messaging().sendToDevice(fcmTokenSnap.val(), payload);
        }

        return { 
            success: true, 
            message: "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù…Ø² PIN Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªØ£Ù…ÙŠÙ† Ø§Ù„Ø­Ø³Ø§Ø¨" 
        };

    } catch (error: any) {
        if (error instanceof functions.https.HttpsError) throw error;
        throw new functions.https.HttpsError('internal', error.message);
    }
});
