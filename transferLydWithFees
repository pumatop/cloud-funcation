const functions = require('firebase-functions');
const admin = require('firebase-admin');

if (admin.apps.length === 0) {
    admin.initializeApp();
}

/**
 * دالة التحويل بالدينار مع الرسوم والحدود:
 * 1. التأكد من حدود المعاملة (مثلاً لا تقل عن 1 ولا تزيد عن 5000).
 * 2. حساب رسوم الخدمة (مثلاً 1% أو مبلغ ثابت).
 * 3. خصم (المبلغ + الرسوم) من المرسل.
 * 4. إضافة المبلغ للمستقبل، وإضافة الرسوم لحساب إيرادات المنصة.
 */
exports.transferLydWithFees = functions.https.onCall(async (data, context) => {
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'يجب تسجيل الدخول أولاً');
    }

    const senderUid = context.auth.uid;
    const { receiverUid, amount } = data;
    const transferAmount = parseFloat(amount);

    // --- 1. إعدادات الحدود والرسوم (يمكنك تغيير الأرقام هنا) ---
    const MIN_LIMIT = 1;      // أدنى مبلغ للتحويل
    const MAX_LIMIT = 5000;   // أقصى مبلغ للتحويل
    const FEE_PERCENT = 0.01; // رسوم خدمة 1%
    const serviceFee = transferAmount * FEE_PERCENT;
    const totalDeduction = transferAmount + serviceFee; // الإجمالي المخصوم من المرسل

    // --- 2. التأكد من الحدود ---
    if (transferAmount < MIN_LIMIT || transferAmount > MAX_LIMIT) {
        throw new functions.https.HttpsError('out-of-range', `المبلغ يجب أن يكون بين ${MIN_LIMIT} و ${MAX_LIMIT} دينار`);
    }

    const db = admin.database();

    try {
        // --- 3. عملية الخصم من المرسل (Transaction) ---
        const senderBalanceRef = db.ref(`users/${senderUid}/wallets/lyd_balance`);
        const senderResult = await senderBalanceRef.transaction((currentBalance) => {
            if (currentBalance === null) return 0;
            if (currentBalance < totalDeduction) return; // رصيد غير كافٍ لتغطية المبلغ + الرسوم
            return currentBalance - totalDeduction;
        });

        if (!senderResult.committed) {
            throw new functions.https.HttpsError('failed-precondition', 'رصيدك لا يكفي لتغطية المبلغ ورسوم الخدمة');
        }

        // --- 4. إضافة المبلغ للمستقبل ---
        await db.ref(`users/${receiverUid}/wallets/lyd_balance`).transaction((currentBalance) => {
            return (currentBalance || 0) + transferAmount;
        });

        // --- 5. وضع الرسوم في إيرادات المنصة (إيرادات تراكمية) ---
        await db.ref('metadata/platform_revenue_lyd').transaction((currentRevenue) => {
            return (currentRevenue || 0) + serviceFee;
        });

        // --- 6. تسجيل العملية للتدقيق ---
        const logRef = db.ref('transfer_logs').push();
        await logRef.set({
            sender: senderUid,
            receiver: receiverUid,
            amount: transferAmount,
            fee: serviceFee,
            total_deducted: totalDeduction,
            currency: 'LYD',
            timestamp: admin.database.ServerValue.TIMESTAMP
        });

        return { 
            success: true, 
            message: `تم التحويل بنجاح. المبلغ: ${transferAmount}، الرسوم: ${serviceFee}` 
        };

    } catch (error) {
        console.error("Transfer Error:", error);
        throw new functions.https.HttpsError('internal', error.message);
    }
});
